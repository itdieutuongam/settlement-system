<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUYẾT TOÁN TẠM ỨNG - QTKT02-BM02</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        
        .form-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            border-bottom: 3px solid #a41017;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .company-name {
            text-align: left;
            font-weight: bold;
            color: #333;
            line-height: 1.4;
        }
        
        .form-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #a41017;
            text-transform: uppercase;
        }
        
        .form-code {
            text-align: right;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .user-info { text-align: right; font-size: 15px; margin-bottom: 20px; }
        .logout { color: #d32f2f; font-weight: bold; text-decoration: none; }

        .alert { padding: 14px 18px; margin: 15px 0; border-radius: 8px; border-left: 6px solid; font-weight: 500; }
        .alert-success { background:#d4edda; border-left-color:#28a745; color:#155724; }
        .alert-danger  { background:#f8d7da; border-left-color:#dc3545; color:#721c24; }
        .alert-warning { background:#fff3cd; border-left-color:#ffc107; color:#856404; }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #a41017;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #a41017;
            margin-bottom: 15px;
        }

        label { display: block; margin: 18px 0 6px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        textarea { min-height: 130px; resize: vertical; }
        input:disabled { background: #f8f9fa; color: #555; }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        table { width: 100%; border-collapse: collapse; margin: 25px 0; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #a41017; color: white; font-weight: bold; }
        
        .btn { padding: 10px 18px; margin: 8px 5px 0 0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #a41017; color: white; font-weight: bold; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; padding: 6px 10px; font-size: 13px; }

        .file-upload { margin: 20px 0; padding: 15px; border: 2px dashed #a41017; border-radius: 8px; text-align: center; background: #f8fbff; }
        .file-upload input[type="file"] { margin-top: 10px; }
        
        .calculation-result {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .calculation-result strong {
            font-size: 1.3em;
            color: #a41017;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="form-header">
        <div class="company-name">
            CÔNG TY CỔ PHẦN DTA - SPACE
        </div>
        <div class="form-title">
            QUYẾT TOÁN TẠM ỨNG
        </div>
        <div class="form-code">
            <strong>Số hiệu biểu</strong><br>
            QTKT02-BM02<br>
            <strong>Ban hành lần</strong>: 01<br>
            <strong>Ngày hiệu lực</strong>: 29/08/2022<br>
            <strong>Số trang</strong>: 1/1
        </div>
    </div>

    <div class="user-info">
        Xin chào <strong>{{ user.name }}</strong> ({{ user.role }})<br>
        <a href="{{ url_for('dashboard') }}">Trang chủ</a> |
        <a href="{{ url_for('logout') }}" class="logout">Đăng xuất</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">
        <!-- PHẦN I: THÔNG TIN NGƯỜI ĐỀ NGHỊ -->
        <div class="form-section">
            <div class="section-title">I. THÔNG TIN TẠM ỨNG</div>
            
            <div class="grid-2">
                <div>
                    <label>Họ và tên người đề nghị:</label>
                    <input type="text" value="{{ user.name }}" disabled>
                </div>
                <div>
                    <label>Phòng ban:</label>
                    <select name="phong_ban" required>
                        <option value="">-- Chọn phòng ban --</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if dept == user.department %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div>
                    <label>Số tiền tạm ứng (VND):</label>
                    <input type="number" name="so_tien_tam_ung" id="tamUng" min="0" value="0" required>
                </div>
                <div>
                    <label>Ngày tạm ứng:</label>
                    <input type="date" name="ngay_tam_ung" required>
                </div>
            </div>

            <label>Lý do tạm ứng <span style="color:red;">*</span>:</label>
            <textarea name="ly_do_tam_ung" placeholder="Mô tả lý do cần tạm ứng..." required></textarea>

            <div class="grid-2">
                <div>
                    <label>Thành phố áp dụng <span style="color:red;">*</span>:</label>
                    <select name="city" required>
                        <option value="" disabled selected>-- Chọn thành phố --</option>
                        <option value="HÀ NỘI">HÀ NỘI</option>
                        <option value="HỒ CHÍ MINH">HỒ CHÍ MINH</option>
                    </select>
                </div>
                <div>
                    <label>Nguồn kinh phí <span style="color:red;">*</span>:</label>
                    <select name="nguon_kinh_phi" required>
                        <option value="" disabled selected>-- Chọn nguồn --</option>
                        {% for item in nguon_kinh_phi_list %}
                        <option value="{{ item }}">{{ item }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- PHẦN II: CHI TIẾT THANH TOÁN -->
        <div class="form-section">
            <div class="section-title">II. CHI TIẾT THANH TOÁN</div>

            <div class="grid-2">
                <div class="checkbox-group">
                    <input type="checkbox" name="loai_chi_phi" value="Khoản mục chi phí" id="chk1">
                    <label for="chk1" style="margin: 0;">Khoản mục chi phí</label>
                </div>
                <div>
                    <label>Nơi phát sinh chi:</label>
                    <input type="text" name="noi_phat_sinh_chi" placeholder="VD: Hà Nội, HCM...">
                </div>
            </div>

            <div class="grid-2">
                <div class="checkbox-group">
                    <input type="checkbox" name="loai_chi_phi" value="Phòng ban chủ ngân sách" id="chk2">
                    <label for="chk2" style="margin: 0;">Phòng ban chủ ngân sách</label>
                </div>
                <div>
                    <label>Mã dự án:</label>
                    <input type="text" name="ma_du_an" placeholder="Nhập mã dự án (nếu có)">
                </div>
            </div>

            <label>Nội dung thanh toán:</label>
            <textarea name="chi_tiet_thanh_toan" placeholder="Chi tiết các khoản thanh toán, hạng mục, số tiền..." rows="5"></textarea>

            <label>Tổng số tiền thanh toán thực tế (VND):</label>
            <input type="number" name="tong_so_tien" id="tongThanhToan" min="0" value="0" required>

            <div class="calculation-result">
                <label style="display: inline;">
                    <input type="radio" name="loai_thanh_toan" value="Thừa" checked> <strong>Thừa</strong>
                </label>
                <label style="display: inline; margin-left: 30px;">
                    <input type="radio" name="loai_thanh_toan" value="Thiếu"> <strong>Thiếu</strong>
                </label>
                <div style="margin-top: 15px;">
                    Số tiền: <strong id="soTienChenhLech">0</strong> VND
                </div>
            </div>
        </div>

        <!-- PHẦN III: PHÊ DUYỆT -->
        <div class="form-section">
            <div class="section-title">III. PHÊ DUYỆT</div>

            <label>Người phê duyệt tiếp theo <span style="color:red;">*</span>:</label>
            <select name="approver" id="approver_select" required>
                <option value="" disabled selected>-- Chọn người duyệt --</option>
                {% for approver in approvers %}
                <option value="{{ approver }}">{{ approver }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="next_approver_name" id="next_approver_name" value="">
        </div>

        <!-- ĐÍNH KÈM TỆP -->
        <div class="file-upload">
            <h3>Đính kèm tệp (nếu có)</h3>
            <p>Hỗ trợ: PDF, Word, Excel, hình ảnh (tối đa 16MB)</p>
            <input type="file" name="attachment" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
        </div>

        <!-- NÚT GỬI -->
        <div style="text-align: center; margin: 40px 0;">
            <button type="submit" class="btn btn-primary" style="padding: 14px 40px; font-size: 17px;">
                Gửi & Chuyển duyệt
            </button>
            <button type="reset" class="btn btn-secondary" style="padding: 14px 30px; font-size: 16px;">
                Làm mới form
            </button>
        </div>
    </form>
</div>

<script>
// Tính toán số tiền chênh lệch (Thừa/Thiếu)
function tinhChenhLech() {
    const tamUng = parseFloat($('#tamUng').val()) || 0;
    const thanhToan = parseFloat($('#tongThanhToan').val()) || 0;
    const chenhLech = Math.abs(tamUng - thanhToan);
    
    $('#soTienChenhLech').text(chenhLech.toLocaleString('vi-VN'));
    
    // Tự động chọn Thừa/Thiếu
    if (tamUng > thanhToan) {
        $('input[name="loai_thanh_toan"][value="Thừa"]').prop('checked', true);
    } else if (thanhToan > tamUng) {
        $('input[name="loai_thanh_toan"][value="Thiếu"]').prop('checked', true);
    }
}

$(document).on('input', '#tamUng, #tongThanhToan', tinhChenhLech);

$(document).ready(function() {
    tinhChenhLech();
});

document.getElementById('approver_select').addEventListener('change', function() {
    const full = this.value;
    const nameOnly = full.split(' - ')[0];
    document.getElementById('next_approver_name').value = nameOnly;
});


</script>
</body>
</html>